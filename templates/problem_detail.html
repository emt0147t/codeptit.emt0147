{% extends "base.html" %}
{% block title %}{{ problem.code }} - {{ problem.title }}{% endblock %}

{% block head %}
<!-- CodeMirror 6 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
<style>
    .CodeMirror {
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 13px;
        height: 400px;
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
    }
    .CodeMirror-focused {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
    }
    .CodeMirror-scroll {
        min-height: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Problem Description -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <span class="text-sm font-mono text-blue-600 bg-blue-50 px-2 py-1 rounded">{{ problem.code }}</span>
                    <span class="ml-2 text-sm diff-{{ problem.difficulty|lower }} px-2 py-1 rounded
                        {% if problem.difficulty == 'Easy' %}bg-green-50
                        {% elif problem.difficulty == 'Medium' %}bg-yellow-50
                        {% else %}bg-red-50{% endif %}">
                        {{ problem.difficulty }}
                    </span>
                </div>
                <div class="text-sm text-gray-500">
                    Th·ªùi gian: {{ problem.time_limit }}s | B·ªô nh·ªõ: {{ problem.memory_limit }}MB
                </div>
            </div>

            <h1 class="text-2xl font-bold text-gray-800 mb-4">{{ problem.title }}</h1>

            <div class="prose max-w-none">
                <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">{{ problem.description }}</div>

                {% if problem.input_description %}
                <h3 class="text-lg font-semibold mt-6 mb-2">D·ªØ li·ªáu v√†o</h3>
                <div class="text-gray-700 whitespace-pre-wrap">{{ problem.input_description }}</div>
                {% endif %}

                {% if problem.output_description %}
                <h3 class="text-lg font-semibold mt-6 mb-2">K·∫øt qu·∫£</h3>
                <div class="text-gray-700 whitespace-pre-wrap">{{ problem.output_description }}</div>
                {% endif %}
            </div>

            <!-- Sample Test Cases -->
            {% if sample_testcases %}
            <h3 class="text-lg font-semibold mt-6 mb-3">V√≠ d·ª•</h3>
            {% for tc in sample_testcases %}
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="text-sm font-medium text-gray-500 mb-1">Input</div>
                    <pre class="bg-gray-900 text-green-400 p-3 rounded-lg text-sm overflow-x-auto">{{ tc.input_data }}</pre>
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-500 mb-1">Output</div>
                    <pre class="bg-gray-900 text-green-400 p-3 rounded-lg text-sm overflow-x-auto">{{ tc.expected_output }}</pre>
                </div>
            </div>
            {% endfor %}
            {% elif problem.sample_input or problem.sample_output %}
            <h3 class="text-lg font-semibold mt-6 mb-3">V√≠ d·ª•</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <div class="text-sm font-medium text-gray-500 mb-1">Input</div>
                    <pre class="bg-gray-900 text-green-400 p-3 rounded-lg text-sm overflow-x-auto">{{ problem.sample_input }}</pre>
                </div>
                <div>
                    <div class="text-sm font-medium text-gray-500 mb-1">Output</div>
                    <pre class="bg-gray-900 text-green-400 p-3 rounded-lg text-sm overflow-x-auto">{{ problem.sample_output }}</pre>
                </div>
            </div>
            {% endif %}

            {% if user and user.is_admin %}
            <div class="mt-4 pt-4 border-t">
                <a href="/admin/problem/{{ problem.code }}/testcases"
                    class="text-purple-600 hover:underline text-sm">‚öôÔ∏è Qu·∫£n l√Ω test cases</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Submit Code Panel -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-sm border p-6 sticky top-4">
            <h3 class="text-lg font-semibold mb-4">N·ªôp b√†i</h3>

            {% if user %}
            <form method="POST" action="/submit">
                <input type="hidden" name="problem_id" value="{{ problem.id }}">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ng√¥n ng·ªØ</label>
                    <select name="language" id="language-select"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="python">Python 3</option>
                        <option value="cpp">C++ 17</option>
                        <option value="c">C</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">M√£ ngu·ªìn</label>
                    <textarea name="source_code" id="source-code" rows="15" required
                        class="hidden"></textarea>
                    <div id="code-editor-wrapper"></div>
                </div>

                <button type="submit"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 rounded-lg transition">
                    üöÄ N·ªôp b√†i
                </button>
            </form>

            <script>
            (function() {
                const langModes = {
                    'python': 'python',
                    'cpp': 'text/x-c++src',
                    'c': 'text/x-csrc'
                };
                const langTemplates = {
                    'python': '# Code Python t·∫°i ƒë√¢y\n\n',
                    'cpp': '#include <iostream>\nusing namespace std;\n\nint main() {\n    \n    return 0;\n}\n',
                    'c': '#include <stdio.h>\n\nint main() {\n    \n    return 0;\n}\n'
                };

                const textarea = document.getElementById('source-code');
                const wrapper = document.getElementById('code-editor-wrapper');
                const select = document.getElementById('language-select');

                const editor = CodeMirror(wrapper, {
                    value: langTemplates[select.value] || '',
                    mode: langModes[select.value] || 'python',
                    theme: 'dracula',
                    lineNumbers: true,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    styleActiveLine: true,
                    indentUnit: 4,
                    tabSize: 4,
                    indentWithTabs: false,
                    lineWrapping: false,
                    extraKeys: {
                        'Tab': function(cm) {
                            if (cm.somethingSelected()) {
                                cm.indentSelection('add');
                            } else {
                                cm.replaceSelection('    ', 'end');
                            }
                        },
                        'Shift-Tab': function(cm) {
                            cm.indentSelection('subtract');
                        }
                    }
                });

                // Sync editor content to hidden textarea on change
                editor.on('change', function() {
                    textarea.value = editor.getValue();
                });

                // Switch language mode when dropdown changes
                select.addEventListener('change', function() {
                    const lang = this.value;
                    editor.setOption('mode', langModes[lang] || 'python');
                    // Only set template if editor is empty or has default template
                    const current = editor.getValue().trim();
                    const isTemplate = Object.values(langTemplates).some(t => t.trim() === current);
                    if (!current || isTemplate) {
                        editor.setValue(langTemplates[lang] || '');
                    }
                });

                // Ensure textarea is synced before form submission
                editor.getWrapperElement().closest('form').addEventListener('submit', function() {
                    textarea.value = editor.getValue();
                });

                // Set initial value
                textarea.value = editor.getValue();
            })();
            </script>
            {% else %}
            <p class="text-gray-500 text-sm">
                Vui l√≤ng <a href="/login" class="text-blue-600 hover:underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ n·ªôp b√†i.
            </p>
            {% endif %}
        </div>

        <!-- User's Submissions -->
        {% if user_submissions %}
        <div class="bg-white rounded-lg shadow-sm border p-6 mt-4">
            <h3 class="text-lg font-semibold mb-3">B√†i n·ªôp g·∫ßn ƒë√¢y</h3>
            <div class="space-y-2">
                {% for s in user_submissions %}
                <a href="/submission/{{ s.id }}" class="block p-2 rounded hover:bg-gray-50 border text-sm">
                    <div class="flex justify-between items-center">
                        <span class="
                            {% if s.status == 'Accepted' %}status-accepted
                            {% elif s.status == 'Wrong Answer' %}status-wrong
                            {% elif s.status == 'Time Limit Exceeded' %}status-tle
                            {% elif s.status == 'Compilation Error' %}status-ce
                            {% elif s.status == 'Runtime Error' %}status-re
                            {% else %}status-pending{% endif %}
                        ">{{ s.status }}</span>
                        <span class="text-gray-400 text-xs">{{ s.created_at.strftime('%d/%m %H:%M') }}</span>
                    </div>
                    <div class="text-gray-500 text-xs mt-1">
                        {{ s.language }} | {{ "%.0f"|format(s.score) }}% | {{ "%.0f"|format(s.time_ms) }}ms
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
